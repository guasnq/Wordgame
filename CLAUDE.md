# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

AI文字游戏渲染器是一个纯前端网页应用，将传统的AI文字对话游戏包装成具有游戏界面的沉浸式体验。用户提供自己的AI服务密钥，在浏览器中通过API直接连接AI进行游戏。用户数据本地存储，保护隐私。

### 核心特点
- 纯前端应用，不依赖自建服务器
- 支持三个主要AI服务商（DeepSeek、Gemini、SiliconFlow），面向成本敏感的中文用户
- 用户数据本地存储，保护隐私
- 可自定义的游戏界面和扩展卡片系统
- 支持长世界观设定，不限制prompt长度以保证游戏体验

## 技术栈和架构

### 前端技术栈
- **React 18+** 主UI框架，支持并发特性和Suspense
- **TypeScript 5+** 类型安全和开发体验
- **Vite 5+** 现代构建工具，快速开发和构建
- **Zustand** 轻量级状态管理，替代Redux的简单方案
- **React Query (TanStack Query)** 服务端状态管理和缓存
- **Jotai** 原子化状态管理，处理复杂局部状态
- **Headless UI + Tailwind CSS** 无样式组件库+原子化CSS
- **Framer Motion** 动画库，提供流畅的界面动画
- **React Hook Form** 表单管理库
- **Zod** TypeScript优先的数据验证库
- **Date-fns** 日期处理库

### 系统架构
```
用户交互层 → 界面渲染层 → 业务逻辑层 → 服务集成层 → 数据存储层
```

### 模块组织结构
```
src/
├── components/          # 通用UI组件
│   ├── ui/             # 基础UI组件
│   └── game/           # 游戏特定组件
├── modules/            # 业务模块
│   ├── core/           # 核心引擎模块
│   │   ├── gameState/  # 游戏状态管理
│   │   ├── dataProcessor/ # 数据处理
│   │   └── eventBus/   # 事件总线
│   ├── ai/             # AI服务模块
│   │   ├── adapters/   # 服务适配器
│   │   │   ├── deepseek/   # DeepSeek适配器
│   │   │   ├── gemini/     # Gemini适配器
│   │   │   └── siliconflow/ # SiliconFlow适配器
│   │   ├── connection/ # 连接管理
│   │   ├── request/    # 请求处理
│   │   ├── error/      # 错误处理
│   │   └── parse/      # 解析引擎
│   ├── ui/             # 界面渲染模块
│   │   ├── game/       # 主游戏界面
│   │   ├── cards/      # 扩展卡片
│   │   ├── layout/     # 布局管理
│   │   └── animation/  # 动画引擎
│   ├── config/         # 配置管理模块
│   │   ├── world/      # 世界观配置
│   │   ├── status/     # 状态栏配置
│   │   ├── ai/         # AI配置
│   │   └── preset/     # 预设管理
│   ├── storage/        # 数据存储模块
│   │   ├── local/      # 本地存储
│   │   ├── import/     # 导入导出
│   │   └── cache/      # 缓存管理
│   ├── interaction/    # 用户交互模块
│   │   ├── input/      # 输入处理
│   │   ├── ui/         # 界面控制
│   │   └── navigation/ # 导航控制
│   └── utils/          # 工具辅助模块
│       ├── performance/ # 性能监控
│       ├── error/      # 错误监控
│       ├── debug/      # 调试工具
│       └── lib/        # 工具库
├── hooks/              # React Hooks
├── stores/             # Zustand状态库
├── types/              # TypeScript类型定义
├── constants/          # 常量定义
├── assets/             # 静态资源
└── app/                # 应用入口和路由
```

## 核心功能和数据流

### 游戏界面四个固定区域
1. **场景描述区** - AI生成的环境、人物、气氛描述
2. **旁白区** - 第三人称视角叙述当前回合的情况变化
3. **行动选择区** - 固定显示3个行动选项按钮（A/B/C）
4. **角色状态区** - 用户自定义的角色属性数值，根据世界观设定而定

### 关键数据流程
```
用户输入 → Prompt组装 → AI请求 → JSON解析 → 界面渲染 → 本地存储
```

### 重要数据格式
- **用户输入**: `{type: "user_input"|"option_click", content: string, option_id?: "A"|"B"|"C"}`
- **AI响应**: 严格的JSON格式，包含scene、narration、options、status、custom字段
- **选项格式**: `{"id": "A|B|C", "text": "行动描述"}`，固定3个选项
- **状态格式**: 进度条类型使用`{"value": number, "max": number}`，数值类型直接使用`number`
- **扩展卡片**: custom字段支持数组、对象、混合数据类型，卡片名称作为key

## 配置系统

### 必填配置项
在开始游戏前，用户必须配置以下两项：
1. **世界观设定** - 游戏背景、规则、角色设定等
2. **状态栏配置** - 角色属性字段定义（生命值、魔力、经验等）

### 扩展卡片系统
用户可自定义添加信息卡片：
- 支持数组、对象、混合数据类型
- 可配置显示位置（左侧/右侧）
- 支持不同显示格式（列表/表格/键值对）
- AI输出的custom字段中必须包含对应的卡片名称作为key

## AI服务集成

### 当前支持的三个主要AI服务商
选择这三个服务商主要考虑成本效益和中文支持：

#### DeepSeek API
- **定价优势**: 目前提供较为优惠的定价策略
- **模型特色**: 支持推理模型（deepseek-reasoner）提供思考过程
- **缓存机制**: 支持KV缓存，命中缓存时费用大幅降低（0.1元/百万tokens vs 1元/百万tokens）
- **兼容性**: 提供OpenAI和Anthropic API格式兼容
- **Base URL**: `https://api.deepseek.com`

#### Google Gemini API
- **模型版本**: 支持最新的gemini-2.5-flash模型
- **多模态**: 原生支持文本、图像等多模态输入
- **实时功能**: 支持Live API进行实时交互
- **认证方式**: 支持API Key和OAuth 2.0两种认证方式
- **Base URL**: `https://generativelanguage.googleapis.com/v1beta`

#### SiliconFlow API
- **模型丰富**: 提供多种开源和商业模型选择
- **服务完整**: 支持聊天、嵌入、重排序、图像生成等多种AI服务
- **批处理**: 支持批量处理功能降低成本
- **账户管理**: 提供余额查询和使用统计功能
- **Base URL**: `https://api.siliconflow.cn/v1`

### AI服务特点
- 用户直接使用自己的API密钥，费用由用户承担
- 支持长世界观设定，不限制prompt长度以保证游戏体验
- 多模型适配器设计，针对不同AI服务的特点进行优化
- 支持服务商间的动态切换和降级

## 错误处理策略

### 四步错误处理流程
1. **约束阶段** - 在prompt中严格要求JSON格式输出
2. **校验阶段** - JSON格式验证和必需字段检查
3. **兜底阶段** - 自动修复常见错误，字段名映射，默认值填充
4. **重试阶段** - 根据错误类型执行重试策略

### 错误分类体系
```
错误总分类
├── 系统级错误 (1000-1999)
│   ├── 网络错误 (1000-1099) - 高级错误，指数退避重试
│   ├── 存储错误 (1100-1199) - 中高级错误
│   └── 内存错误 (1200-1299) - 高级错误
├── 业务级错误 (2000-2999)
│   ├── 输入验证错误 (2000-2099) - 低级错误，不重试
│   ├── 状态错误 (2100-2199) - 中级错误
│   └── 配置错误 (2300-2399) - 需要用户修复
└── AI服务错误 (3000-3999) - 根据具体错误码决定重试策略
    ├── 通用调用错误 (3000-3099)
    ├── DeepSeek特定错误 (3010-3019)
    ├── Gemini特定错误 (3020-3029)
    ├── SiliconFlow特定错误 (3030-3039)
    └── 响应解析错误 (3200-3299) - 中级错误，可重试
```

### 服务商特定错误处理
#### DeepSeek特定错误
- **推理模式失败** (3010): 自动切换到标准模式
- **KV缓存错误** (3011): 禁用缓存继续请求
- **兼容模式错误** (3012): 切换到原生格式
- **Token计算错误** (3013): 使用预估值

#### Gemini特定错误
- **安全过滤器拦截** (3020): 提示用户修改内容或调整安全设置
- **多模态处理错误** (3021): 降级到纯文本模式
- **Live API错误** (3022): 切换到标准API
- **OAuth认证错误** (3023): 提示重新授权

#### SiliconFlow特定错误
- **余额不足** (3030): 提示充值或切换服务商
- **批处理错误** (3031): 切换到单次请求模式
- **模型切换错误** (3032): 使用默认模型
- **语音服务错误** (3033): 禁用语音功能

## 开发指导

### 常用开发命令
项目使用现代前端工具链，当package.json存在时的常用命令：
```bash
# 开发环境启动
npm run dev

# 代码检查
npm run lint
npm run typecheck

# 测试运行
npm test
npm run test:e2e

# 构建
npm run build
```

### 开发策略和优先级
#### UI界面优先开发模式
采用**UI界面优先**的开发策略，每完成一个核心模块立即进行界面测试验证：
```
开发流程：UI集成 → 模块开发 → 界面测试 → 功能验证
```

#### 阶段性开发计划
1. **第一阶段（MVP）**：AI连接、JSON解析容错、四个固定区域、世界观和状态栏配置
2. **第二阶段**：扩展卡片系统、预设管理、导入导出功能  
3. **第三阶段**：主题系统、性能优化、用户引导

### 代码规范
- 使用TypeScript进行严格类型检查
- 遵循ESLint + Prettier代码格式化规则
- 组件使用React函数式组件和Hooks
- 状态管理优先使用Zustand，复杂状态使用Jotai
- CSS使用Tailwind原子化类名

### 测试策略
- **单元测试**: Jest + React Testing Library
- **E2E测试**: Playwright
- **API适配器测试**: Mock三个主要AI服务的响应
- **错误场景测试**: 故障注入和边界条件测试，重点测试AI服务降级
- **AI特定测试**: 
  - DeepSeek推理模式和缓存测试
  - Gemini安全过滤器和多模态测试
  - SiliconFlow余额监控和模型切换测试

### 性能考虑（针对三个主要AI服务商优化）
- **本地存储限制**: 100MB（增加以支持更多数据）
- **历史记录限制**: 200回合（超出后自动压缩）
- **组件渲染**: 使用React.memo防止不必要重渲染
- **代码分割**: 按路由和功能模块进行懒加载，AI适配器懒加载
- **Prompt管理**: 根据不同AI服务的能力动态调整，优先保证游戏体验
- **智能Prompt管理**: 超过50回合时自动压缩历史摘要，保留关键信息

#### 服务商特定性能优化
- **DeepSeek**: 
  - 利用KV缓存减少重复计算成本
  - 智能选择推理模式vs标准模式
  - Token计算本地化避免额外API调用
- **Gemini**: 
  - 上下文缓存优化长对话
  - 多模态内容预加载
  - 安全过滤器结果缓存
- **SiliconFlow**: 
  - 批处理合并多个请求
  - 智能模型切换避免高峰拥堵
  - 余额预加载避免请求失败

### 数据和限制说明
#### 系统限制（不限制游戏体验）
```typescript
const SYSTEM_LIMITS = {
  // 请求处理限制
  maxRequestSize: 2048 * 1024,  // 2MB（支持更大的多模态输入）
  maxResponseSize: 1024 * 1024, // 1MB（支持更长的AI响应）
  
  // 本地存储限制（受浏览器限制）
  maxLocalStorageSize: 100,     // 100MB
  maxSaveFileSize: 20,          // 20MB
  maxConfigSize: 200,           // 200KB
  
  // 用户体验优化
  maxHistoryRounds: 200,        // 200回合
  maxExtensionCards: 15,        // 15个扩展卡片
  maxStatusFields: 30,          // 30个状态字段
  
  // 注意：不限制prompt长度和世界观内容长度，以保证游戏体验
};
```

### 部署方式
- 静态站点部署（Vercel、Netlify、Cloudflare Pages）
- CDN分发，全球节点访问
- 自动构建部署：Git提交触发CI/CD
- 强制HTTPS和CSP安全策略

## 重要约束

### 功能边界
- **纯前端应用**: 不提供后端服务
- **用户直连AI**: 不代理AI服务，用户费用自理
- **单人游戏**: 不支持多人游戏或在线分享  
- **无账号系统**: 不需要注册登录

### 数据安全和隐私
- **API密钥**: 仅本地存储，不传输到服务器
- **游戏数据**: 本地化存储，用户完全控制
- **隐私保护**: 不收集用户数据，不依赖第三方分析

### 技术限制
- **浏览器兼容性**: 支持现代浏览器，需要fetch API和localStorage
- **存档管理**: 保留最近200回合，超出部分提示导出
- **CORS限制**: 需要AI服务支持跨域请求
- **成本控制**: 各服务商定价策略不同，需引导用户合理使用

### AI服务商适配约束
- **DeepSeek**: 兼容OpenAI格式但有推理模式扩展，KV缓存可显著降低成本
- **Gemini**: Google特有的API格式和认证方式，上下文缓存技术
- **SiliconFlow**: 统一格式但支持多种底层模型，批处理和模型切换策略

## 关键设计原则

### 用户体验优先
- **游戏体验**: 不限制prompt长度和世界观内容，优先保证沉浸感
- **成本控制**: 针对中文用户的成本敏感特点优化
- **容错性**: 完善的四步错误处理流程，自动恢复和降级

### 开发原则
- **防御性编程**: 输入验证、边界检查、类型检查
- **模块化设计**: 清晰的模块边界和接口定义
- **性能优化**: 针对三个AI服务商的特点分别优化
- **可维护性**: TypeScript类型安全，完善的错误处理和监控

---

## 快速开发参考

### AI服务集成检查清单
开发AI适配器时的关键检查项：
- [ ] API密钥验证和错误处理
- [ ] 请求格式适配各服务商规范
- [ ] 响应解析和容错处理
- [ ] 服务商特定功能支持（DeepSeek推理、Gemini多模态、SiliconFlow批处理）
- [ ] 错误分类和重试策略
- [ ] 成本优化特性（缓存、批处理等）

### 数据流验证要点
- [ ] 用户输入格式正确 `{type, content, option_id?}`
- [ ] AI响应JSON格式 `{scene, narration, options[3], status, custom}`
- [ ] 状态字段类型匹配用户配置
- [ ] 扩展卡片数据结构正确
- [ ] 本地存储数据完整性

### 错误处理验证
- [ ] 四步错误处理流程：约束→校验→兜底→重试
- [ ] 服务商特定错误码处理
- [ ] 用户友好错误提示
- [ ] 自动降级和恢复机制

这个文档将随着项目开发不断更新和完善。