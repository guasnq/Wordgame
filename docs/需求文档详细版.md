# AI文字游戏渲染器 - 详细需求文档

## 1. 产品定位

### 1.1 产品概述
AI文字游戏渲染器是一个前端网页应用，将传统的AI文字对话游戏包装成具有游戏界面的沉浸式体验。用户提供自己的AI服务密钥，在浏览器中通过API直接连接AI进行游戏，用户数据和游戏配置均在本地存储，不依赖自建服务器。

### 1.2 核心价值
- 将纯文字对话升级为可视化游戏界面
- 提供可自定义的游戏信息展示
- 支持多种AI服务和游戏主题
- 用户数据本地化存储，保护隐私（需连接第三方AI服务）

### 1.3 目标用户
- 经常使用ChatGPT等AI进行文字冒险游戏的玩家
- 具备基础技术能力，能够获取和配置AI服务密钥
- 希望获得更佳游戏体验的文字游戏爱好者

## 2. 功能需求

### 2.1 核心游戏界面（固定四个区域）

#### 2.1.1 场景描述区
- **位置**：界面主要区域的上半部分
- **内容**：AI生成的环境、人物、气氛描述
- **要求**：文字具有沉浸感，包含时间、地点、人物、情绪等要素
- **展示**：支持文字排版和基础样式

#### 2.1.2 旁白区  
- **位置**：场景描述下方
- **内容**：以第三人称视角叙述当前回合的情况变化
- **要求**：简洁明了，不重复场景描述的内容，采用旁白叙述风格
- **长度**：1-3句话为宜

#### 2.1.3 行动选择区
- **位置**：界面下方
- **内容**：固定显示3个行动选项按钮
- **交互**：点击按钮自动填入输入框并发送
- **处理**：严格要求AI输出3个选项，解析失败时显示默认选项（继续/等待/返回）

#### 2.1.4 角色状态区
- **位置**：右侧，默认收起状态
- **内容**：由用户自定义的角色属性数值（根据世界观设定而定）
- **配置要求**：用户必须在游戏开始前配置状态字段，与世界观设定同为必填项
- **交互**：点击展开详细状态面板
- **更新**：每回合根据AI输出更新数值
- **灵活性**：支持不同世界观的不同属性类型（进度条、数值、等级等）

### 2.2 自定义扩展卡片系统

#### 2.2.1 卡片配置功能
用户可以自定义添加信息卡片，包含以下配置项：
- **卡片名称**：如"背包"、"任务"、"好感度"等
- **显示位置**：左侧或右侧
- **数据类型**：array（数组）、object（对象）、mixed（混合）
- **显示格式**：列表、表格、键值对等
- **更新频率**：每回合更新 或 按需更新
- **内容描述**：告诉AI要输出什么信息
- **prompt注入**：系统自动将卡片要求添加到AI指令的custom部分
- **解析规则**：AI返回的custom字段中必须包含对应的卡片名称作为key
- **数量限制**：最多显示几条信息
- **排序规则**：按时间、重要性等排序

#### 2.2.2 卡片展示逻辑
- **有内容时**：正常显示AI输出的信息
- **无内容时**：显示预设的占位文字或隐藏
- **内容过长**：自动折叠，支持展开查看
- **移动端**：统一收起为抽屉式展示

#### 2.2.3 常见卡片类型示例
- **背包物品**：显示当前携带的物品列表
- **任务进度**：显示正在进行的任务和完成状态
- **人物关系**：显示与NPC的好感度变化
- **技能等级**：显示各项技能的等级和经验
- **金钱变化**：显示收入支出和当前余额

### 2.3 AI服务连接管理

#### 2.3.1 支持的AI服务（开发阶段三个主要服务商）
- **DeepSeek API**：高性价比AI服务，支持推理模式(deepseek-reasoner)和KV缓存优化
  - 特点：成本效益高，兼容OpenAI和Anthropic格式，提供思考过程透明化
  - 模型：deepseek-chat、deepseek-reasoner等
  - 优势：长上下文支持，推理能力强，费用低廉
- **Google Gemini API**：多模态AI服务，支持gemini-2.5-flash最新模型
  - 特点：原生多模态支持，Live API实时交互，强大的安全控制机制
  - 模型：gemini-2.5-flash、gemini-pro等
  - 优势：响应速度快，多模态处理能力，上下文缓存技术
- **SiliconFlow API**：多模型聚合平台，提供丰富的模型选择
  - 特点：支持多种开源和闭源模型，批处理降低成本，多种AI服务类型
  - 模型：Qwen、GLM、Llama系列等多种选择
  - 优势：模型种类丰富，灵活切换，批量处理优化

#### 2.3.2 连接配置项
**通用配置**
- **API密钥**：用户的身份验证密钥（Bearer Token格式）
- **模型名称**：指定使用的具体模型
- **请求参数**：温度值(0.1-2.0)、最大回复长度、停止词等
- **超时设置**：请求超时时间（10-120秒，适应不同服务商响应特点）

**服务商特定配置**
- **DeepSeek**：支持推理模式开关、KV缓存优化选项
- **Gemini**：支持上下文缓存配置、安全等级设置、多模态参数
- **SiliconFlow**：支持模型切换策略、批处理配置、负载均衡

#### 2.3.3 连接测试和服务监控
- **连接测试**：针对每个服务商的特点发送测试请求
  - DeepSeek：测试基础对话和推理模式可用性
  - Gemini：测试API访问和安全过滤器设置
  - SiliconFlow：测试模型列表获取和切换能力
- **服务状态监控**：实时检测服务可用性和响应时间
- **错误诊断**：提供详细的错误信息和修复建议
- **使用量统计**：跟踪token消耗和成本估算（适配各服务商计费方式）

### 2.4 游戏设定管理

#### 2.4.1 世界观编辑器（必填项）
- **文本编辑**：支持长文本编写游戏背景、世界观、角色设定
- **规则定义**：定义游戏规则、胜负条件、特殊机制
- **格式支持**：支持基础的Markdown格式

#### 2.4.2 状态栏配置器（必填项）
- **字段定义**：用户必须定义角色的状态字段（如生命值、魔力、金钱等）
- **字段类型**：支持进度条类型（有最大值）和数值类型（无上限）
- **显示名称**：为每个字段设置用户友好的显示名称
- **初始值设定**：为每个字段设置游戏开始时的初始数值
- **必填验证**：状态栏配置与世界观设定同为开始游戏的必要条件
- **预设模板**：提供常见世界观的状态字段模板供参考

#### 2.4.3 预设管理
- **保存预设**：将世界观、AI配置、扩展卡片配置打包保存
- **预设切换**：可以在多个游戏设定间快速切换
- **预设分享**：支持导出预设文件，导入他人的预设
- **示例预设**：内置几个完整的示例供新用户体验

### 2.5 本地数据管理

#### 2.5.1 游戏存档
- **回合记录**：保存每回合的用户输入、AI回复、时间戳
- **状态快照**：保存角色状态、扩展卡片内容的变化
- **历史浏览**：支持查看历史回合内容
- **存档限制**：保留最近100回合，超出部分提示导出

#### 2.5.2 导入导出功能
- **导出内容**：游戏设定、存档历史、扩展配置（不包含API密钥）
- **文件格式**：JSON格式，便于备份和分享
- **导入恢复**：支持完整恢复游戏状态和设置
- **版本兼容**：处理不同版本间的数据兼容性

### 2.6 界面主题系统

#### 2.6.1 模板切换
- **主题模板**：提供多种视觉风格（古风、科幻、现代等）
- **实时切换**：可在游戏中随时更换主题，不影响游戏数据
- **自定义**：支持用户自定义颜色、字体等基础样式

#### 2.6.2 响应式布局
- **桌面端**：左中右三栏布局，充分利用屏幕空间
- **平板端**：左侧卡片收起，保持中右布局
- **手机端**：主游戏区域优先，扩展卡片收入抽屉

## 3. 技术架构需求

### 3.1 数据格式规范

#### 3.1.0 完整数据流程示例
```javascript
// 用户输入
{type: "user_input", content: "我想向北走"}

// 网站发送给AI的prompt（文本格式）
`=== 游戏世界观 ===
中世纪奇幻世界...

=== 输出要求 ===
请严格按照以下JSON格式输出：
{
  "scene": "场景描述...",
  "narration": "旁白内容...",
  "options": [
    {"id": "A", "text": "选项A"},
    {"id": "B", "text": "选项B"},
    {"id": "C", "text": "选项C"}
  ],
  "status": {
    "health": {"value": 数值, "max": 数值},  // 进度条类型
    "experience": 数值,  // 数值类型（无上限）
    // 具体字段由用户的状态栏配置决定
  },
  "custom": {
    "背包": ["物品列表"],
    "任务": {"任务名": "进度"}
  }
}`

// AI返回的数据
{
  "scene": "你踏上通往北方的小径...",
  "narration": "你的脚步在寂静的林间回响",
  "options": [
    {"id": "A", "text": "加快脚步前进"},
    {"id": "B", "text": "放慢速度观察"},
    {"id": "C", "text": "找地方休息"}
  ],
  "status": {
    "health": {"value": 75, "max": 100},
    "mana": {"value": 30, "max": 50},
    "experience": 260,
    "gold": 50
    // 示例：中世纪奇幻世界观的状态字段
  },
  "custom": {
    "背包": ["面包 x2", "水瓶 x1"],
    "任务": {"探索森林": "进行中 4/5"}
  }
}

// 网站内部存储格式
{
  round_id: "round_001",
  timestamp: "2024-01-01T10:00:00Z",
  user_input: {type: "user_input", content: "我想向北走"},
  ai_response: {/* AI返回的完整数据 */},
  parse_status: "success"
}
```

### 3.2 AI数据处理分工

#### 3.2.1 发送给AI的数据
- **游戏设定**：世界观、规则、角色背景
- **历史摘要**：前几回合的关键信息（精简版）
- **用户指令**：当前回合玩家的操作输入
- **输出要求**：指定AI需要输出的内容格式和扩展卡片要求
- **当前状态**：角色状态作为AI决策参考

#### 3.2.2 AI返回的数据
- **场景描述**：新回合的环境和情况描述
- **旁白内容**：以第三人称视角的叙述内容
- **行动选项**：3个可选行动，格式为`{"id": "A/B/C", "text": "行动描述"}`
- **状态更新**：角色属性的新数值
- **扩展内容**：custom字段中的各种数据类型（数组、对象、混合）

#### 3.2.3 网站处理的数据
- **内容解析**：从AI回复中提取各部分内容
- **格式校验**：检查AI输出是否符合预期格式
- **界面渲染**：将内容显示到对应的界面区域
- **数据存储**：保存到浏览器本地存储
- **错误处理**：处理AI回复异常的情况

### 3.3 数据流程设计

#### 3.3.1 游戏回合流程
1. 用户输入操作指令或点击选项
2. 网站组装完整的提示内容（设定+历史+当前指令+输出要求）
3. 发送请求到AI服务
4. 接收AI回复并解析内容
5. 更新游戏界面各个区域
6. 保存回合数据到本地存储

#### 3.3.2 错误处理流程（四步法：约束+校验+兜底+重试）

**第一步：约束阶段**
- 在prompt中严格要求JSON格式输出
- 明确指定必需字段和数据类型
- 提供具体的输出格式示例

**第二步：校验阶段**  
- JSON格式验证和语法检查
- 必需字段完整性检查
- 数据类型和结构验证

**第三步：兜底阶段**
- 自动修复常见格式错误（补全引号、逗号等）
- 字段名近义词映射（如"事件"→"narration"）
- 缺失字段用默认值填充

**第四步：重试阶段**
- **网络错误**：显示错误提示，允许重试，保持当前状态
- **解析失败**：调整prompt强调格式要求后重试1次
- **API配额超限**：显示明确提示，建议用户检查配额
- **连接超时**：自动重试1次，仍失败则提示用户

## 4. 用户体验需求

### 4.1 交互设计
- **快捷键支持**：回车发送、ESC关闭面板等
- **一键操作**：点击选项自动填入并发送
- **状态反馈**：请求中显示加载状态，错误时明确提示
- **平滑动画**：界面切换和内容更新使用适当动画

### 4.2 性能要求
- **首屏加载**：3秒内可操作（宽带网络环境）
- **回合渲染**：300毫秒内完成界面更新（不含AI响应时间）
- **内存管理**：长时间游玩不出现明显卡顿
- **存储限制**：本地数据控制在合理范围，超出时提示导出
- **智能Prompt管理**：根据不同AI模型的能力动态调整prompt结构，优先保证游戏体验，必要时自动压缩历史信息而不限制世界观内容
- **历史数据压缩**：超过50回合时自动压缩历史摘要，保留关键信息
- **Token使用统计**：跟踪API调用消耗，提供使用量提醒（需适配各AI服务商计费规则）
- **多模型适配**：针对不同AI服务的响应速度、稳定性、格式理解能力制定不同策略

### 4.3 可用性要求
- **新手引导**：提供完整的使用教程和示例
- **容错能力**：各种异常情况下都能保持基本可用
- **离线浏览**：网络断开时可以查看历史记录
- **数据安全**：API密钥等敏感信息仅本地存储

## 5. 约束与限制

### 5.1 功能边界
- **不做服务端**：纯前端应用，不提供后端服务
- **不做AI托管**：不代理AI服务，用户直连
- **不做社交功能**：不支持多人游戏或在线分享
- **不做账号系统**：不需要注册登录

### 5.2 技术限制
- **浏览器兼容性**：支持主流现代浏览器，需要支持fetch API和localStorage
- **存储限制**：受浏览器本地存储容量限制（通常5-10MB）
- **网络依赖**：必须连接第三方AI服务，无法离线运行核心功能
- **CORS限制**：需要AI服务支持跨域请求，或通过代理服务解决
- **API兼容性**：三个主要服务商的API格式和特点差异较大：
  - DeepSeek：兼容OpenAI格式但有推理模式扩展
  - Gemini：Google特有的API格式和认证方式
  - SiliconFlow：统一格式但支持多种底层模型
- **用户成本控制**：各服务商的定价策略和优化方式不同：
  - DeepSeek：KV缓存可显著降低成本，需要引导用户合理使用
  - Gemini：上下文缓存技术降低重复内容费用
  - SiliconFlow：批处理和模型切换策略影响成本
- **模型能力差异**：针对JSON输出稳定性的不同表现：
  - DeepSeek：JSON格式输出较稳定，推理模式提供思考过程
  - Gemini：格式理解能力强，但安全过滤可能影响输出
  - SiliconFlow：不同底层模型的JSON输出质量差异较大

## 6. 验收标准

### 6.1 核心功能验收
- [ ] 能成功连接并测试三种主要AI服务（DeepSeek、Gemini、SiliconFlow）
- [ ] 四个固定区域能正确显示AI生成的内容
- [ ] 三个行动选项始终可用，交互正常
- [ ] 用户必须配置世界观和状态栏才能开始游戏
- [ ] 状态栏支持用户自定义字段，根据不同世界观灵活配置
- [ ] AI能正确输出用户配置的状态字段并更新数值
- [ ] 能完成至少10回合的连续游戏流程
- [ ] AI返回JSON格式错误时能正确修复和降级处理
- [ ] custom字段支持数组、对象等多种数据类型
- [ ] 选项格式正确解析为`{"id": "A", "text": "..."}`格式

### 6.2 扩展功能验收
- [ ] 能添加和配置自定义扩展卡片
- [ ] 扩展卡片内容能根据AI输出正确更新
- [ ] 支持至少3种不同类型的扩展卡片
- [ ] 主题模板切换功能正常，不丢失数据
- [ ] 预设管理包含世界观+状态栏配置的完整保存和切换
- [ ] 导出导入功能完整，能100%恢复游戏状态

### 6.3 稳定性验收
- [ ] 网络异常时不会丢失当前游戏进度
- [ ] AI回复格式异常时有合理的降级处理
- [ ] 长时间游玩（50+回合）性能稳定
- [ ] 移动端和桌面端都能正常使用
- [ ] API密钥等敏感信息不会意外泄露

## 7. 开发优先级

### 第一阶段：核心功能（MVP）
1. AI连接和基础对话功能
2. AI回复的JSON解析和容错处理（四步法）
3. 四个固定区域的内容显示
4. 世界观设定和状态栏配置功能（必填项）
5. 基础的custom字段支持
6. 简单的本地存储和历史记录

### 第二阶段：扩展功能
1. 自定义扩展卡片系统
2. 游戏设定管理和预设功能
3. 导入导出功能
4. 界面优化和响应式适配

### 第三阶段：完善体验
1. 主题模板系统
2. 性能优化和错误监控
3. 新手引导和帮助文档
4. 细节优化和bug修复

---

**总结**：本产品是一个纯前端的AI文字游戏渲染器，专注于将AI对话包装成游戏界面，提供可定制的沉浸式游戏体验。核心在于内容渲染和用户体验，而非游戏逻辑本身。